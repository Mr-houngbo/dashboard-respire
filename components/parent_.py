import streamlit as st
import pandas as pd
import requests
from urllib.parse import urlencode,quote_plus
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import numpy as np
import os
import json
from twilio.rest import Client
import time



# Configuration (√† adapter selon vos donn√©es)
BASE_URL = "https://api.airgradient.com/public/api/v1"
token = "77a25676-a9ec-4a99-9137-f33e6776b590"
location_id = "164928"
DATA_DIR = os.path.join(os.path.dirname(__file__), '..', 'data/air_quality')



#=============================================================================================================

def show_header(nom_ecole: str = "Ecole Multinationnale de Telecoms ", logo_path: str = None):
    """
    Affiche un en-t√™te moderne et attractif pour la page √âcole.
    :param nom_ecole: Nom de l'√©cole √† afficher (optionnel)
    :param logo_path: Chemin vers le logo de l'√©cole (optionnel)
    """
    
    # CSS personnalis√© pour l'animation et le style
    st.markdown("""
    <style>
    .header-container {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 50%, #a5d6a7 100%);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(46, 125, 50, 0.1);
        border: 2px solid rgba(46, 125, 50, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .title-main {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1b5e20;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 10px;
        animation: fadeInUp 1s ease-out;
    }
    
    .subtitle {
        font-size: 1.3rem;
        color: #2e7d32;
        margin-bottom: 15px;
        font-weight: 500;
        animation: fadeInUp 1.2s ease-out;
    }
    
    .school-name {
        font-size: 1.1rem;
        color: #4caf50;
        background: rgba(255,255,255,0.7);
        padding: 8px 15px;
        border-radius: 25px;
        display: inline-block;
        margin-top: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        animation: fadeInUp 1.4s ease-out;
    }
    
    .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
    
    .logo-image {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 3px solid white;
        animation: bounce 2s infinite;
    }
    
    .air-emoji {
        font-size: 2rem;
        animation: float 3s ease-in-out infinite;
        margin: 0 10px;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }
    
    @keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }
    
    .decorative-line {
        height: 4px;
        background: linear-gradient(90deg, #4caf50, #81c784, #a5d6a7, #4caf50);
        border-radius: 2px;
        margin: 20px 0;
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% {
            background-position: -200px 0;
        }
        100% {
            background-position: 200px 0;
        }
    }
    </style>
    """, unsafe_allow_html=True)

    # Conteneur principal avec design moderne
    with st.container():
        st.markdown('<div class="header-container">', unsafe_allow_html=True)
        
        col1, col2 = st.columns([4, 1])
        
        with col1:
            # Titre principal avec emojis anim√©s
            st.markdown(
                """
                <div class="title-main">
                    Bienvenue sur l'espace parents de Respire
                </div>
                """,
                unsafe_allow_html=True
            )
            
            # Sous-titre engageant
            st.markdown(
                '<div class="subtitle">D√©couvrez comment va l\'air de l\'√©cole de votre enfant aujourd\'hui !</div>',
                unsafe_allow_html=True
            )
            
            # Nom de l'√©cole avec style modernis√©
            if nom_ecole:
                st.markdown(
                    f'<div class="school-name">üè´ {nom_ecole}</div>',
                    unsafe_allow_html=True
                )
        
        with col2:
            if logo_path:
                st.markdown('<div class="logo-container">', unsafe_allow_html=True)
                try:
                    st.image(logo_path, width=100, use_container_width=False)
                except:
                    # Fallback si l'image ne se charge pas
                    st.markdown(
                        '<div style="font-size: 60px; text-align: center;">üè´</div>',
                        unsafe_allow_html=True
                    )
                st.markdown('</div>', unsafe_allow_html=True)
            else:
                # Logo par d√©faut si aucun logo fourni
                st.markdown(
                    '<div class="logo-container"><div style="font-size: 60px; text-align: center;">üè´</div></div>',
                    unsafe_allow_html=True
                )
        
        st.markdown('</div>', unsafe_allow_html=True)
        
        # Ligne d√©corative anim√©e
        st.markdown('<div class="decorative-line"></div>', unsafe_allow_html=True)

#=============================================================================================================

def fetch_current_data(location_id: str, token: str) -> pd.DataFrame:
    """R√©cup√®re les donn√©es actuelles de qualit√© de l'air"""
    endpoint = f"/locations/{location_id}/measures/current"
    params = {"token": token}
    full_url = f"{BASE_URL}{endpoint}?{urlencode(params)}"
    
    try:
        response = requests.get(full_url)
        response.raise_for_status()
        data = response.json()
        
        if isinstance(data, dict):
            if "measures" in data:
                return pd.DataFrame([data["measures"]])
            else:
                return pd.DataFrame([data])
        elif isinstance(data, list):
            return pd.DataFrame(data)
        
        return pd.DataFrame()
    except Exception as e:
        st.error(f"Erreur lors de la r√©cup√©ration des donn√©es: {e}")
        return pd.DataFrame()


def calculate_air_quality_status(df):
    """Calcule le statut global de la qualit√© de l'air pour les parents"""
    if df.empty:
        return None
    
    # R√©cup√©ration des valeurs principales
    pm25 = df.get('pm02_corrected', [0]).iloc[0] if 'pm02_corrected' in df.columns else 0
    co2 = df.get('rco2_corrected', [400]).iloc[0] if 'rco2_corrected' in df.columns else 400
    temp = df.get('atmp_corrected', [25]).iloc[0] if 'atmp_corrected' in df.columns else 25
    humidity = df.get('rhum_corrected', [50]).iloc[0] if 'rhum_corrected' in df.columns else 50
    
    # Logique de classification simplifi√©e pour les parents
    risk_level = 0
    
    # PM2.5 (particules fines)
    if pm25 > 35:
        risk_level += 3
    elif pm25 > 15:
        risk_level += 2
    elif pm25 > 10:
        risk_level += 1
    
    # CO2 (ventilation)
    if co2 > 1000:
        risk_level += 2
    elif co2 > 800:
        risk_level += 1
    
    # Classification finale
    if risk_level == 0:
        status = "Excellente"
        color = "#4caf50"
        icon = "üòä"
        message = "L'air est pur ! Votre enfant respire dans de bonnes conditions."
        advice = "Parfait pour toutes les activit√©s √† l'√©cole."
    elif risk_level <= 2:
        status = "Bonne"
        color = "#8bc34a"
        icon = "üôÇ"
        message = "La qualit√© de l'air est satisfaisante."
        advice = "Conditions normales, rien √† signaler."
    elif risk_level <= 4:
        status = "Moyenne"
        color = "#ff9800"
        icon = "üòê"
        message = "L'air pourrait √™tre mieux. Surveillez les sympt√¥mes chez votre enfant."
        advice = "Encouragez votre enfant √† bien s'hydrater."
    elif risk_level <= 6:
        status = "Mauvaise"
        color = "#f44336"
        icon = "üò∑"
        message = "Air pollu√©. Soyez vigilant aux signes de g√™ne respiratoire."
        advice = "Contactez l'√©cole si votre enfant tousse ou a du mal √† respirer."
    else:
        status = "Tr√®s mauvaise"
        color = "#d32f2f"
        icon = "üò®"
        message = "Air tr√®s pollu√© ! Surveillez attentivement votre enfant."
        advice = "Consultez un m√©decin si votre enfant pr√©sente des sympt√¥mes."
    
    return {
        "status": status,
        "color": color,
        "icon": icon,
        "message": message,
        "advice": advice,
        "pm25": pm25,
        "co2": co2,
        "temp": temp,
        "humidity": humidity,
        "last_update": datetime.now().strftime("%H:%M")
    }


def show_air_status_summary(school_name="√âcole Multinationale des T√©l√©communications"):
    """
    BLOC I: Affiche l'√©tat de l'air aujourd'hui - Version parents
    Grande carte r√©cap' simplifi√©e, compr√©hensible en 5 secondes
    """
    
    st.markdown("## üè´ √âtat de l'air aujourd'hui √† l'√©cole")
    
    # R√©cup√©ration des donn√©es
    df = fetch_current_data(location_id, token)
    air_status = calculate_air_quality_status(df)
    
    if not air_status:
        st.error("‚ùå Impossible de r√©cup√©rer les donn√©es de qualit√© de l'air")
        return
    
    # CSS pour la grande carte
    st.markdown("""
    <style>
    .air-status-card {{
        background: linear-gradient(135deg, {color}15, {color}08);
        border: 3px solid {color}40;
        border-radius: 25px;
        padding: 30px;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 10px 30px {color}20;
        position: relative;
        overflow: hidden;
    }}
    
    .status-icon {{
        font-size: 4rem;
        margin-bottom: 15px;
        animation: pulse 2s ease-in-out infinite;
    }}
    
    .status-title {{
        font-size: 2.5rem;
        font-weight: bold;
        color: {color};
        margin-bottom: 10px;
    }}
    
    .status-message {{
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 15px;
        line-height: 1.5;
    }}
    
    .status-advice {{
        font-size: 1.1rem;
        color: #666;
        font-style: italic;
        margin-bottom: 20px;
    }}
    
    .school-info {{
        background: inherit;
        padding: 15px;
        border-radius: 15px;
        margin-top: 20px;
    }}
    
    .last-update {{
        font-size: 0.9rem;
        color: #888;
        margin-top: 10px;
    }}
    
    @keyframes pulse {{
        0%%, 100%% {{ transform: scale(1); }}
        50%% {{ transform: scale(1.1); }}
    }}
    </style>
    """.format(color=air_status["color"]), unsafe_allow_html=True)
    
    # Grande carte de statut
    st.markdown(f'''
    <div class="air-status-card" style="
        background: linear-gradient(135deg, {air_status["color"]}15, {air_status["color"]}08);
        border: 3px solid {air_status["color"]}40;
        box-shadow: 0 10px 30px {air_status["color"]}20;
    ">
        <div class="status-icon">{air_status["icon"]}</div>
        <div class="status-title" style="color: {air_status["color"]};">
            Qualit√©: {air_status["status"]}
        </div>
        <div class="status-message">
            {air_status["message"]}
        </div>
        <div class="status-advice">
            üí° {air_status["advice"]}
        </div>
        <div class="school-info">
            <div style="font-size: 1.1rem; color: #333; font-weight: 600;">
                üìç {school_name}
            </div>
            <div class="last-update">
                üïê Derni√®re mesure: {air_status["last_update"]}
            </div>
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    # Indicateurs rapides en bas
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        pm25_color = "#4caf50" if air_status["pm25"] <= 15 else "#ff9800" if air_status["pm25"] <= 35 else "#f44336"
        st.markdown(f'''
        <div style="background: {pm25_color}20; padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem;">üå´Ô∏è</div>
            <div style="font-weight: bold; color: {pm25_color};">PM2.5</div>
            <div style="font-size: 1.2rem; font-weight: bold;">{air_status["pm25"]:.1f}</div>
            <div style="font-size: 0.8rem; color: #666;">¬µg/m¬≥</div>
        </div>
        ''', unsafe_allow_html=True)
    
    with col2:
        co2_color = "#4caf50" if air_status["co2"] <= 800 else "#ff9800" if air_status["co2"] <= 1000 else "#f44336"
        st.markdown(f'''
        <div style="background: {co2_color}20; padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem;">üí®</div>
            <div style="font-weight: bold; color: {co2_color};">CO‚ÇÇ</div>
            <div style="font-size: 1.2rem; font-weight: bold;">{air_status["co2"]:.0f}</div>
            <div style="font-size: 0.8rem; color: #666;">ppm</div>
        </div>
        ''', unsafe_allow_html=True)
    
    with col3:
        temp_color = "#4caf50" if 18 <= air_status["temp"] <= 26 else "#ff9800"
        st.markdown(f'''
        <div style="background: {temp_color}20; padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem;">üå°Ô∏è</div>
            <div style="font-weight: bold; color: {temp_color};">Temp.</div>
            <div style="font-size: 1.2rem; font-weight: bold;">{air_status["temp"]:.1f}¬∞C</div>
            <div style="font-size: 0.8rem; color: #666;">int√©rieur</div>
        </div>
        ''', unsafe_allow_html=True)
    
    with col4:
        humidity_color = "#4caf50" if 40 <= air_status["humidity"] <= 60 else "#ff9800"
        st.markdown(f'''
        <div style="background: {humidity_color}20; padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem;">üíß</div>
            <div style="font-weight: bold; color: {humidity_color};">Humidit√©</div>
            <div style="font-size: 1.2rem; font-weight: bold;">{air_status["humidity"]:.0f}%</div>
            <div style="font-size: 0.8rem; color: #666;">relative</div>
        </div>
        ''', unsafe_allow_html=True)


def show_health_parameters():
    """
    BLOC II: Param√®tres de sant√© critiques
    Indicateurs cl√©s avec seuils explicites et explications pour les parents
    """
    
    st.markdown("## Param√®tres de sant√© √† surveiller")
    st.markdown("*Comprendre les indicateurs qui affectent la sant√© de votre enfant*")
    
    # R√©cup√©ration des donn√©es
    df = fetch_current_data(location_id, token)
    if df.empty:
        st.warning("Donn√©es non disponibles pour le moment")
        return
    
    # Extraction des valeurs
    pm25 = df.get('pm02_corrected', [0]).iloc[0] if 'pm02_corrected' in df.columns else 0
    co2 = df.get('rco2_corrected', [400]).iloc[0] if 'rco2_corrected' in df.columns else 400
    temp = df.get('atmp_corrected', [25]).iloc[0] if 'atmp_corrected' in df.columns else 25
    humidity = df.get('rhum_corrected', [50]).iloc[0] if 'rhum_corrected' in df.columns else 50
    
    # CSS pour les cartes de param√®tres
    st.markdown("""
    <style>
    .health-param-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin: 15px 0;
        box-shadow: 0 6px 25px rgba(0,0,0,0.1);
        border-left: 6px solid;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .health-param-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 35px rgba(0,0,0,0.15);
    }
    
    .param-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .param-icon {
        font-size: 2.5rem;
        margin-right: 15px;
    }
    
    .param-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .param-value {
        font-size: 2rem;
        font-weight: 900;
        margin: 10px 0;
    }
    
    .param-status {
        font-size: 1.1rem;
        font-weight: 600;
        padding: 8px 15px;
        border-radius: 25px;
        display: inline-block;
        margin: 10px 0;
    }
    
    .param-explanation {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .param-advice {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
    }
    
    .threshold-indicator {
        display: flex;
        justify-content: space-between;
        background: #f5f5f5;
        padding: 10px;
        border-radius: 10px;
        margin: 10px 0;
        font-size: 0.85rem;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # Fonction pour d√©terminer le statut d'un param√®tre
    def get_param_status(value, thresholds, unit=""):
        if value <= thresholds[0]:
            return {"status": "Excellent", "color": "#4caf50", "bg": "#e8f5e8"}
        elif value <= thresholds[1]:
            return {"status": "Bon", "color": "#8bc34a", "bg": "#f1f8e9"}
        elif value <= thresholds[2]:
            return {"status": "Moyen", "color": "#ff9800", "bg": "#fff3e0"}
        else:
            return {"status": "Pr√©occupant", "color": "#f44336", "bg": "#ffebee"}
    
    # 1. PM2.5 - Particules fines
    pm25_status = get_param_status(pm25, [12, 25, 35])
    st.markdown(f'''
    <div class="health-param-card" style="border-left-color: {pm25_status["color"]};">
        <div class="param-header">
            <div class="param-icon">üå´Ô∏è</div>
            <div>
                <div class="param-title" style="color: {pm25_status["color"]};">PM2.5 - Particules fines</div>
                <div style="color: #666; font-size: 0.9rem;">Poussi√®res invisibles dans l'air</div>
            </div>
        </div>
        <div class="param-value" style="color: {pm25_status["color"]};">
            {pm25:.1f} ¬µg/m¬≥
        </div>
        <div class="param-status" style="background: {pm25_status["bg"]}; color: {pm25_status["color"]};">
            {pm25_status["status"]}
        </div>
        <div class="param-explanation">
            <h4> Qu'est-ce que c'est ?</h4>
            Les PM2.5 sont des particules si petites qu'elles peuvent p√©n√©trer profond√©ment dans les poumons de votre enfant. 
            Elles proviennent de la pollution des v√©hicules, de la poussi√®re, ou des fum√©es.
            <h4>‚ö†Ô∏è Effets sur la sant√©</h4>
            <b>Exposition faible:</b> Aucun probl√®me<br>
            <b>Exposition moyenne:</b> Peut causer toux, irritation des yeux<br>
            <b>Exposition √©lev√©e:</b> Difficult√©s respiratoires, fatigue
        </div>
        <div class="threshold-indicator">
            <span style="color: #4caf50;">üü¢ Excellent: 0-12</span>
            <span style="color: #ff9800;">üü° Moyen: 12-35</span>
            <span style="color: #f44336;">üî¥ √âlev√©: >35</span>
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    # Conseil sp√©cifique PM2.5
    if pm25 > 35:
        advice = "üö® <b>Action recommand√©e:</b> Gardez votre enfant √† l'int√©rieur, fermez les fen√™tres. Consultez un m√©decin s'il tousse."
    elif pm25 > 25:
        advice = "‚ö†Ô∏è <b>Conseil:</b> Limitez les activit√©s ext√©rieures intenses. Surveillez si votre enfant tousse ou a les yeux qui piquent."
    else:
        advice = " <b>Parfait:</b> Votre enfant peut faire toutes ses activit√©s normalement."
    
    st.markdown(f'<div class="param-advice">{advice}</div>', unsafe_allow_html=True)
    
    # st.markdown("---")
    
    # 2. CO‚ÇÇ - Qualit√© de l'air int√©rieur
    co2_status = get_param_status(co2, [600, 800, 1000])
    st.markdown(f'''
    <div class="health-param-card" style="border-left-color: {co2_status["color"]};">
        <div class="param-header">
            <div class="param-icon">üí®</div>
            <div>
                <div class="param-title" style="color: {co2_status["color"]};">CO‚ÇÇ - Dioxyde de carbone</div>
                <div style="color: #666; font-size: 0.9rem;">Indicateur de ventilation en classe</div>
            </div>
        </div>
        <div class="param-value" style="color: {co2_status["color"]};">
            {co2:.0f} ppm
        </div>
        <div class="param-status" style="background: {co2_status["bg"]}; color: {co2_status["color"]};">
            {co2_status["status"]}
        </div>
        <div class="param-explanation">
            <h4> Qu'est-ce que c'est ?</h4>
            Le CO‚ÇÇ nous indique si la classe est bien a√©r√©e. Quand il y a beaucoup d'√©l√®ves dans une pi√®ce ferm√©e, 
            le taux de CO‚ÇÇ augmente et l'oxyg√®ne diminue.
            <h4>‚ö†Ô∏è Effets sur la sant√©</h4>
            <b>Taux normal:</b> Concentration et apprentissage optimaux<br>
            <b>Taux √©lev√©:</b> Fatigue, somnolence, difficult√©s de concentration<br>
            <b>Taux tr√®s √©lev√©:</b> Maux de t√™te, sensation d'√©touffement
        </div>
        <div class="threshold-indicator">
            <span style="color: #4caf50;">üü¢ Excellent: <600</span>
            <span style="color: #ff9800;">üü° Moyen: 600-1000</span>
            <span style="color: #f44336;">üî¥ √âlev√©: >1000</span>
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    # Conseil sp√©cifique CO‚ÇÇ
    if co2 > 1000:
        advice = "üö® <b>Action recommand√©e:</b> La classe manque d'air frais. Contactez l'√©cole pour am√©liorer la ventilation."
    elif co2 > 800:
        advice = "‚ö†Ô∏è <b>Conseil:</b> La ventilation pourrait √™tre am√©lior√©e. Votre enfant pourrait √™tre plus fatigu√© que d'habitude."
    else:
        advice = " <b>Parfait:</b> La classe est bien a√©r√©e, conditions id√©ales pour l'apprentissage."
    
    st.markdown(f'<div class="param-advice">{advice}</div>', unsafe_allow_html=True)
    
    # st.markdown("---")
    
    # 3. Temp√©rature
    temp_status = get_param_status(abs(temp - 22), [2, 4, 6])  # √âcart par rapport √† 22¬∞C id√©al
    st.markdown(f'''
    <div class="health-param-card" style="border-left-color: {temp_status["color"]};">
        <div class="param-header">
            <div class="param-icon">üå°Ô∏è</div>
            <div>
                <div class="param-title" style="color: {temp_status["color"]};">Temp√©rature int√©rieure</div>
                <div style="color: #666; font-size: 0.9rem;">Confort thermique en classe</div>
            </div>
        </div>
        <div class="param-value" style="color: {temp_status["color"]};">
            {temp:.1f}¬∞C
        </div>
        <div class="param-status" style="background: {temp_status["bg"]}; color: {temp_status["color"]};">
            {temp_status["status"]}
        </div>
        <div class="param-explanation">
            <h4> Pourquoi c'est important ?</h4>
            Une temp√©rature appropri√©e aide votre enfant √† rester concentr√© et confortable. 
            Trop chaud ou trop froid peut affecter son attention et son bien-√™tre.
            <h4>‚ö†Ô∏è Effets sur le confort</h4>
            <b>18-24¬∞C:</b> Temp√©rature id√©ale pour l'apprentissage<br>
            <b>Trop chaud (>26¬∞C):</b> Fatigue, somnolence<br>
            <b>Trop froid (<18¬∞C):</b> Difficult√©s de concentration
        </div>        
        <div class="threshold-indicator">
            <span style="color: #4caf50;">üü¢ Id√©al: 20-24¬∞C</span>
            <span style="color: #ff9800;">üü° Acceptable: 18-26¬∞C</span>
            <span style="color: #f44336;">üî¥ Inconfortable: <18 ou >26¬∞C</span>
        </div>
    </div>
    ''', unsafe_allow_html=True)
    
    # st.markdown("---")
    
    # 4. Humidit√©
    humidity_status = get_param_status(abs(humidity - 50), [10, 20, 30])  # √âcart par rapport √† 50% id√©al
    st.markdown(f'''
    <div class="health-param-card" style="border-left-color: {humidity_status["color"]};">
        <div class="param-header">
            <div class="param-icon">üíß</div>
            <div>
                <div class="param-title" style="color: {humidity_status["color"]};">Humidit√© relative</div>
                <div style="color: #666; font-size: 0.9rem;">Taux d'humidit√© dans l'air</div>
            </div>
        </div>
        <div class="param-value" style="color: {humidity_status["color"]};">
            {humidity:.0f}%
        </div>        
        <div class="param-status" style="background: {humidity_status["bg"]}; color: {humidity_status["color"]};">
            {humidity_status["status"]}
        </div>
        <div class="param-explanation">
            <h4> Qu'est-ce que c'est ?</h4>
            L'humidit√© influence la propagation des virus et le confort respiratoire. 
            Un air trop sec ou trop humide peut causer des probl√®mes.
            <h4>‚ö†Ô∏è Effets sur la sant√©</h4>
            <b>40-60%:</b> Id√©al pour la sant√© respiratoire<br>
            <b>Trop sec (<40%):</b> Irritation des voies respiratoires, nez sec<br>
            <b>Trop humide (>60%):</b> Favorise moisissures et virus
        </div>
        <div class="threshold-indicator">
            <span style="color: #4caf50;">üü¢ Id√©al: 40-60%</span>
            <span style="color: #ff9800;">üü° Acceptable: 30-70%</span>
            <span style="color: #f44336;">üî¥ Probl√©matique: <30% ou >70%</span>
        </div>
    </div>
    ''', unsafe_allow_html=True)


def render_bloc_tendances(location_id: str = location_id, school_name="ESMT"):
    """
    Bloc III - Tendances pour la page Parent
    Utilise les fonctions existantes et les donn√©es CSV locales
    """
    
    st.markdown("### **√âvolution cette semaine**")
    
    # Container principal avec style
    with st.container():
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                    padding: 20px; border-radius: 15px; margin-bottom: 20px; 
                    border: 1px solid #dee2e6;">
        """, unsafe_allow_html=True)
        
        # === R√âCUP√âRATION DES DONN√âES ===
        csv_filename = f"{DATA_DIR}/{location_id}.csv"
        
        # V√©rifier si le fichier CSV existe
        if os.path.exists(csv_filename):
            try:
                df_historical = pd.read_csv(csv_filename)
                df_historical['date'] = pd.to_datetime(df_historical['Local Date/Time'])
                
                # Prendre les 7 derniers jours
                recent_data = df_historical.tail(7).copy()
                
                if len(recent_data) == 0:
                    st.warning("Aucune donn√©e historique disponible pour cette √©cole.")
                    st.markdown("</div>", unsafe_allow_html=True)
                    return
                    
            except Exception as e:
                st.error(f"Erreur lors du chargement des donn√©es : {e}")
                st.markdown("</div>", unsafe_allow_html=True)
                return
        else:
            st.warning(f"Fichier de donn√©es non trouv√© : {csv_filename}")
            st.markdown("</div>", unsafe_allow_html=True)
            return
        
        # Colonnes pour organiser l'affichage
        col1, col2 = st.columns([2, 1])
        
        with col1:
            # === MINI GRAPHIQUE D'√âVOLUTION ===
            st.markdown("#### **Qualit√© de l'air - 7 derniers jours**")
            
            # Utiliser les vraies colonnes de tes donn√©es
            pm25_col = 'PM2.5 (Œºg/m¬≥) corrected' if 'PM2.5 (Œºg/m¬≥) corrected' in recent_data.columns else 'pm25'
            co2_col = 'CO2 (ppm) corrected' if 'CO2 (ppm) corrected' in recent_data.columns else 'co2'
            temp_col = 'Temperature (¬∞C) corrected' if 'Temperature (¬∞C) corrected' in recent_data.columns else 'temperature'
            humidity_col = 'Humidity (%) corrected' if 'Humidity (%) corrected' in recent_data.columns else 'humidity'
            
            # Fonction pour d√©terminer le statut (utilise ta logique existante)
            def get_air_quality_status_from_pm25(pm25):
                if pm25 <= 10:
                    return "Excellente", "#4caf50"
                elif pm25 <= 15:
                    return "Bonne", "#8bc34a"
                elif pm25 <= 35:
                    return "Moyenne", "#ff9800"
                elif pm25 <= 55:
                    return "Mauvaise", "#f44336"
                else:
                    return "Tr√®s mauvaise", "#d32f2f"
            
            # V√©rifier que la colonne PM2.5 existe
            if pm25_col in recent_data.columns:
                # Calcul des statuts pour chaque jour
                recent_data['status'], recent_data['color'] = zip(*recent_data[pm25_col].apply(get_air_quality_status_from_pm25))
                
                # Graphique sparkline avec Plotly
                fig = go.Figure()
                
                # Ligne principale
                fig.add_trace(go.Scatter(
                    x=recent_data['date'],
                    y=recent_data[pm25_col],
                    mode='lines+markers',
                    line=dict(color='#007bff', width=3),
                    marker=dict(size=8, color=recent_data['color']),
                    name='PM2.5 (¬µg/m¬≥)',
                    hovertemplate='<b>%{x|%d/%m}</b><br>' +
                                 'PM2.5: %{y:.1f} ¬µg/m¬≥<br>' +
                                 '<extra></extra>'
                ))
                
                # Zones de seuils (selon ta logique)
                fig.add_hline(y=10, line_dash="dash", line_color="#4caf50", 
                             annotation_text="Seuil Excellent", annotation_position="right")
                fig.add_hline(y=15, line_dash="dash", line_color="#8bc34a", 
                             annotation_text="Seuil Bon", annotation_position="right")
                fig.add_hline(y=35, line_dash="dash", line_color="#ff9800", 
                             annotation_text="Seuil Moyen", annotation_position="right")
                
                fig.update_layout(
                    height=300,
                    margin=dict(l=0, r=0, t=20, b=0),
                    showlegend=False,
                    xaxis=dict(
                        showgrid=True,
                        gridcolor='lightgray',
                        tickformat='%d/%m'
                    ),
                    yaxis=dict(
                        title="PM2.5 (¬µg/m¬≥)",
                        showgrid=True,
                        gridcolor='lightgray'
                    ),
                    plot_bgcolor='rgba(0,0,0,0)',
                    paper_bgcolor='rgba(0,0,0,0)'
                )
                
                st.plotly_chart(fig, use_container_width=True)
                
                # === R√âSUM√â DE LA SEMAINE ===
                st.markdown("#### **R√©sum√© de la semaine**")
                
                # Calculs statistiques sur les vraies donn√©es
                avg_pm25 = recent_data[pm25_col].mean()
                max_pm25 = recent_data[pm25_col].max()
                days_over_threshold = len(recent_data[recent_data[pm25_col] > 35])
                
                # Affichage en colonnes
                col_stat1, col_stat2, col_stat3 = st.columns(3)
                
                with col_stat1:
                    status_avg = "Correct" if avg_pm25 <= 25 else "√âlev√©"
                    delta_color = "normal" if avg_pm25 <= 25 else "inverse"
                    st.metric(
                        label="üìä Moyenne PM2.5", 
                        value=f"{avg_pm25:.1f} ¬µg/m¬≥",
                        delta=status_avg,
                        delta_color=delta_color
                    )
                
                with col_stat2:
                    status_max = "Acceptable" if max_pm25 <= 35 else "Pr√©occupant"
                    delta_color = "normal" if max_pm25 <= 35 else "inverse"
                    st.metric(
                        label="üìà Pic maximum", 
                        value=f"{max_pm25:.1f} ¬µg/m¬≥",
                        delta=status_max,
                        delta_color=delta_color
                    )
                
                with col_stat3:
                    status_days = "Aucun souci" if days_over_threshold == 0 else "√Ä surveiller"
                    delta_color = "normal" if days_over_threshold == 0 else "inverse"
                    st.metric(
                        label="‚ö†Ô∏è Jours d'alerte", 
                        value=f"{days_over_threshold} jour(s)",
                        delta=status_days,
                        delta_color=delta_color
                    )
            else:
                st.error(f"Colonne PM2.5 non trouv√©e dans les donn√©es. Colonnes disponibles : {list(recent_data.columns)}")
        
        with col2:
            
            # === PLAGES HORAIRES CRITIQUES ===
            st.markdown("#### **Analyse par jour**")
            
            # Analyser chaque jour des donn√©es r√©elles
            if pm25_col in recent_data.columns:
                for idx, row in recent_data.iterrows():
                    
                    jours_fr = {                                      # Pour la convertion du Nom du jour en francais 
                            "Monday": "Lundi",
                            "Tuesday": "Mardi",
                            "Wednesday": "Mercredi",
                            "Thursday": "Jeudi",
                            "Friday": "Vendredi",
                            "Saturday": "Samedi",
                            "Sunday": "Dimanche"
                            }
                    date_str = jours_fr[row['date'].strftime('%A')]   # Nom du jour
                                                
                    
                    pm25_val = row[pm25_col]
                    # D√©terminer le statut du jour
                    if pm25_val <= 15:
                        icon = ""
                        level = "Bon"
                        color = "#28a745"
                        message = f"{date_str} : {icon} Journ√©e saine (PM2.5: {pm25_val:.1f})"
                    elif pm25_val <= 35:
                        icon = "‚ö°"
                        level = "Moyen"
                        color = "#ffc107"
                        message = f"{date_str} : {icon} Qualit√© correcte (PM2.5: {pm25_val:.1f})"
                    else:
                        icon = "‚ö†Ô∏è"
                        level = "√âlev√©"
                        color = "#dc3545"
                        message = f"{date_str} : {icon} Pollution d√©tect√©e (PM2.5: {pm25_val:.1f})"
                    st.markdown(f"""
                    <div style="background-color: {color}15; 
                               border-left: 4px solid {color}; 
                               padding: 8px 12px; margin: 5px 0; border-radius: 5px;">
                        {message}
                    </div>
                    """, unsafe_allow_html=True)
            
            # === ALERTES AUTOMATIQUES ===
            st.markdown("#### üîî Alertes de la semaine")
            
            if pm25_col in recent_data.columns:
                days_over_threshold = len(recent_data[recent_data[pm25_col] > 35])
                
                if days_over_threshold > 0:
                    max_pollution_day = recent_data.loc[recent_data[pm25_col].idxmax()]
                    st.markdown(f"""
                    <div style="background-color: #dc354520; border: 1px solid #dc3545; 
                               border-radius: 8px; padding: 15px; margin: 10px 0;">
                        <strong>‚ö†Ô∏è {days_over_threshold} jour(s) avec d√©passement de seuil</strong><br>
                        <small>Pic de {max_pollution_day[pm25_col]:.1f} ¬µg/m¬≥ le {max_pollution_day['date'].strftime('%d/%m')}. 
                        Surveillez les sympt√¥mes respiratoires.</small>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.markdown("""
                    <div style="background-color: #28a74520; border: 1px solid #28a745; 
                               border-radius: 8px; padding: 15px; margin: 10px 0;">
                        <strong> Aucune alerte cette semaine</strong><br>
                        <small>La qualit√© de l'air est rest√©e dans les normes acceptables.</small>
                    </div>
                    """, unsafe_allow_html=True)
        
        st.markdown("</div>", unsafe_allow_html=True)
        
        # === INTERPR√âTATION AUTOMATIQUE (utilise ta logique existante) ===
        st.markdown("#### **Ce que cela signifie pour votre enfant**")
        
        if pm25_col in recent_data.columns:
            avg_pm25 = recent_data[pm25_col].mean()
            
            # G√©n√©rer des conseils bas√©s sur ta logique calculate_air_quality_status
            if avg_pm25 <= 15:
                interpretation = """
                üß† Excellente nouvelle ! L'air √† l'√©cole a √©t√© globalement de tr√®s bonne qualit√© cette semaine. 
                Votre enfant peut participer √† toutes les activit√©s sans contrainte particuli√®re.
                """
                advice_color = "#4caf50"
            elif avg_pm25 <= 35:
                interpretation = """
                ‚ö†Ô∏è Qualit√© correcte mais √† surveiller. Quelques variations ont √©t√© observ√©es. 
                Encouragez votre enfant √† bien s'hydrater et surveillez d'√©ventuels sympt√¥mes (toux, fatigue).
                """
                advice_color = "#ff9800"
            else:
                interpretation = """
                üö® Attention requise. La qualit√© de l'air a √©t√© pr√©occupante plusieurs jours. 
                Consultez un m√©decin si votre enfant pr√©sente toux persistante, maux de t√™te ou fatigue inhabituelle.
                """
                advice_color = "#f44336"
            st.markdown(f"""
            <div style="background-color: {advice_color}15; border: 2px solid {advice_color}; 
                       border-radius: 10px; padding: 20px; margin: 15px 0;">
                {interpretation}
            </div>
            """, unsafe_allow_html=True)


def render_bloc_conseils(location_id: str = location_id, token: str = token, school_name="ESMT"):
    """
    Bloc IV - Conseils/Actions pr√©ventives pour la page Parent
    Conseils personnalis√©s selon la qualit√© de l'air √† l'√©cole de l'enfant
    """
    
    st.markdown("### üß© **Conseils & Actions pr√©ventives**")
    
    # R√©cup√©rer les donn√©es actuelles de l'√©cole
    current_data = fetch_current_data(location_id, token)
    air_status = calculate_air_quality_status(current_data) if not current_data.empty else None
    
    # Container principal
    with st.container():
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); 
                    padding: 25px; border-radius: 15px; margin-bottom: 20px; 
                    border: 1px solid #b3d9ff;">
        """, unsafe_allow_html=True)
        
        if air_status:
            # === SECTION 1: QUE PUIS-JE FAIRE √Ä LA MAISON ? ===
            st.markdown("#### üè† **Que puis-je faire √† la maison ?**")
            
            # Conseils personnalis√©s selon la qualit√© de l'air √† l'√©cole
            pm25 = air_status['pm25']
            co2 = air_status['co2']
            status = air_status['status']
            
            col1, col2 = st.columns([1, 1])
            
            with col1:
                st.markdown("##### üåÖ **Pr√©paration du matin**")
                
                if pm25 <= 15:  # Air de bonne qualit√© √† l'√©cole
                    morning_tips = [
                        "‚úÖ <strong>Petit-d√©jeuner copieux</strong> - Votre enfant peut d√©penser son √©nergie normalement",
                        "üö™ <strong>Fen√™tres ouvertes</strong> - A√©rez sa chambre avant le d√©part pour l'√©cole",
                        "üëï <strong>Habits l√©gers</strong> - Pas de protection particuli√®re n√©cessaire",
                        "üíß <strong>Gourde d'eau</strong> - Hydratation normale suffit"
                    ]
                    tips_color = "#d4edda"
                    border_color = "#28a745"
                elif pm25 <= 35:  # Air moyen √† l'√©cole
                    morning_tips = [
                        "‚ö†Ô∏è <strong>Petit-d√©jeuner riche</strong> - Donnez-lui des forces pour la journ√©e",
                        "üè† <strong>A√©ration matinale</strong> - Ouvrez 5-10 min quand l'air ext√©rieur est plus frais",
                        "üß• <strong>Veste l√©g√®re</strong> - Au cas o√π l'√©cole limite les sorties",
                        "üíß <strong>Grande gourde</strong> - Encouragez √† boire plus que d'habitude"
                    ]
                    tips_color = "#fff3cd"
                    border_color = "#ffc107"
                else:  # Air pollu√© √† l'√©cole
                    morning_tips = [
                        "üö® <strong>Petit-d√©jeuner √©nerg√©tique</strong> - Fruits, c√©r√©ales pour renforcer ses d√©fenses",
                        "üö™ <strong>Fen√™tres ferm√©es</strong> - Gardez l'air int√©rieur propre avant le d√©part",
                        "üò∑ <strong>Masque dans le sac</strong> - Si l'√©cole le demande ou si trajet √† pied",
                        "üíß <strong>Double hydratation</strong> - Pr√©voyez une grande gourde + thermos"
                    ]
                    tips_color = "#f8d7da"
                    border_color = "#dc3545"
                
                # Affichage des conseils
                for tip in morning_tips:
                    st.markdown(f"""
                    <div style="background-color: {tips_color}; border-left: 4px solid {border_color}; 
                               padding: 10px; margin: 8px 0; border-radius: 5px;">
                        {tip}
                    </div>
                    """, unsafe_allow_html=True)
            
            with col2:
                st.markdown("##### üåÜ **Apr√®s l'√©cole**")
                
                if pm25 <= 15:  # Air de bonne qualit√©
                    evening_tips = [
                        "üèÉ <strong>Activit√©s ext√©rieures</strong> - Parfait pour jouer dehors apr√®s l'√©cole",
                        "üõÅ <strong>Douche normale</strong> - Pas de pr√©cautions particuli√®res",
                        "ü•ó <strong>Repas √©quilibr√©</strong> - Alimentation normale suffit",
                        "üò¥ <strong>Coucher habituel</strong> - Son organisme n'est pas stress√©"
                    ]
                    tips_color = "#d4edda"
                    border_color = "#28a745"
                elif pm25 <= 35:  # Air moyen
                    evening_tips = [
                        "üè† <strong>Activit√©s √† l'int√©rieur</strong> - Privil√©giez les jeux calmes en rentrant",
                        "üõÅ <strong>Douche rapide</strong> - Rincez le visage et les mains",
                        "üçä <strong>Fruits vitamin√©s</strong> - Oranges, kiwis pour renforcer l'immunit√©",
                        "üëÇ <strong>√âcoutez-le</strong> - Demandez s'il a ressenti de la fatigue ou g√™ne"
                    ]
                    tips_color = "#fff3cd"
                    border_color = "#ffc107"
                else:  # Air pollu√©
                    evening_tips = [
                        "üö™ <strong>Rentrez vite</strong> - √âvitez les d√©tours et jeux ext√©rieurs",
                        "üõÅ <strong>Douche obligatoire</strong> - Cheveux et visage pour √©liminer les particules",
                        "ü•ï <strong>Alimentation anti-oxydante</strong> - L√©gumes color√©s, th√© l√©ger",
                        "ü©∫ <strong>Surveillance</strong> - V√©rifiez toux, maux de t√™te ou fatigue inhabituelle"
                    ]
                    tips_color = "#f8d7da"
                    border_color = "#dc3545"
                
                # Affichage des conseils du soir
                for tip in evening_tips:
                    st.markdown(f"""
                    <div style="background-color: {tips_color}; border-left: 4px solid {border_color}; 
                               padding: 10px; margin: 8px 0; border-radius: 5px;">
                        {tip}
                    </div>
                    """, unsafe_allow_html=True)
            
            # === SECTION 2: QUAND DOIS-JE M'INQUI√âTER ? ===
            st.markdown("---")
            st.markdown("#### ü©∫ **Quand dois-je m'inqui√©ter ?**")
            
            # Seuils d'alerte personnalis√©s selon l'√©cole
            col_alert1, col_alert2 = st.columns([1, 1])
            
            with col_alert1:
                st.markdown("##### ‚ö†Ô∏è **Sympt√¥mes √† surveiller**")
                
                if pm25 <= 15:
                    alert_message = """
                    <div style="background-color: #d4edda; border: 2px solid #28a745; 
                               border-radius: 10px; padding: 15px;">
                        <strong>üòä Situation rassurante</strong><br>
                        L'air √† l'√©cole est de bonne qualit√©. Les sympt√¥mes suivants sont peu probables 
                        mais restez attentif √† :
                        <ul>
                            <li>Toux persistante (+ de 2 jours)</li>
                            <li>Fatigue inhabituelle</li>
                            <li>Maux de t√™te fr√©quents</li>
                        </ul>
                    </div>
                    """
                elif pm25 <= 35:
                    alert_message = """
                    <div style="background-color: #fff3cd; border: 2px solid #ffc107; 
                               border-radius: 10px; padding: 15px;">
                        <strong>‚ö†Ô∏è Vigilance mod√©r√©e</strong><br>
                        L'air √† l'√©cole est correct mais surveillez ces signaux :
                        <ul>
                            <li><strong>Toux s√®che</strong> en rentrant de l'√©cole</li>
                            <li><strong>Yeux qui piquent</strong> ou nez qui coule</li>
                            <li><strong>Fatigue</strong> apr√®s les r√©cr√©ations</li>
                            <li><strong>Difficult√©s de concentration</strong> en classe</li>
                        </ul>
                    </div>
                    """
                else:
                    alert_message = """
                    <div style="background-color: #f8d7da; border: 2px solid #dc3545; 
                               border-radius: 10px; padding: 15px;">
                        <strong>üö® Surveillance renforc√©e</strong><br>
                        L'air √† l'√©cole est pollu√©. Consultez un m√©decin si votre enfant pr√©sente :
                        <ul>
                            <li><strong>Toux persistante</strong> (surtout le soir)</li>
                            <li><strong>Essoufflement</strong> inhabituel</li>
                            <li><strong>Maux de t√™te</strong> fr√©quents</li>
                            <li><strong>Irritation des yeux/gorge</strong></li>
                            <li><strong>Fatigue extr√™me</strong> au retour</li>
                        </ul>
                    </div>
                    """
                
                st.markdown(alert_message, unsafe_allow_html=True)
            
            with col_alert2:
                st.markdown("##### üìû **Actions √† entreprendre**")
                
                # Actions sp√©cifiques selon le niveau de pollution √† l'√©cole
                if pm25 <= 15:
                    action_items = [
                        ("üí¨", "<strong>Dialogue avec l'enfant</strong>", "Demandez-lui comment il se sent √† l'√©cole"),
                        ("üìö", "<strong>Suivi scolaire normal</strong>", "Aucune restriction d'activit√© n√©cessaire"),
                        ("üè•", "<strong>M√©decin si n√©cessaire</strong>", "Seulement si sympt√¥mes inhabituels persistent pendant plusieurs jours ")
                    ]
                    action_color = "#28a745"
                elif pm25 <= 35:
                    action_items = [
                        ("üìû", "<strong>Contact avec l'√©cole</strong>", "Demandez si d'autres enfants ont des sympt√¥mes"),
                        ("üíß", "<strong>Hydratation renforc√©e</strong>", "Encouragez √† boire plus pendant les pauses"),
                        ("üë®‚Äç‚öïÔ∏è", "<strong>M√©decin si symptoms</strong>", "Consultation si toux + fatigue > 3 jours"),
                        ("üìù", "<strong>Journal des sympt√¥mes</strong>", "Notez les moments o√π l'enfant tousse")
                    ]
                    action_color = "#ffc107"
                else:
                    action_items = [
                        ("üö®", "<strong>Contact √©cole imm√©diat</strong>", "Signalez les sympt√¥mes √† l'enseignant"),
                        ("üè•", "<strong>M√©decin rapidement</strong>", "Consultation si sympt√¥mes > 24h"),
                        ("üì±", "<strong>Alertes pollution</strong>", "Installez une app m√©t√©o avec qualit√© de l'air"),
                        ("üè†", "<strong>Adaptation √† domicile</strong>", "Purificateur d'air si possible"),
                        ("üìã", "<strong>Suivi quotidien</strong>", "Temp√©rature, toux, √©nergie de l'enfant")
                    ]
                    action_color = "#dc3545"
                
                for icon, title, description in action_items:
                    st.markdown(f"""
                    <div style="border-left: 4px solid {action_color}; padding: 10px; margin: 8px 0;">
                        <strong>{icon} {title}</strong><br>
                        <small>{description}</small>
                    </div>
                    """, unsafe_allow_html=True)
            
            # === SECTION 3: RESSOURCES ET CONTACTS ===
            st.markdown("---")
            st.markdown("#### üìö **Ressources utiles**")
            
            col_resource1, col_resource2 = st.columns([1, 1])
            
            with col_resource1:
                st.markdown("""
                ##### üìñ **En savoir plus**
                
                - ü´Å **Qu'est-ce que le PM2.5 ?** ‚Üí Particules fines qui p√©n√®trent dans les poumons
                - üè´ **Pourquoi surveiller √† l'√©cole ?** ‚Üí Les enfants y passent 6-8h par jour
                - üí® **CO‚ÇÇ et concentration** ‚Üí Trop de CO‚ÇÇ fatigue et r√©duit l'attention
                - üå°Ô∏è **Temp√©rature et confort** ‚Üí Impact sur l'apprentissage
                """)
            
            with col_resource2:
                st.markdown(f"""
                ##### üìû **Contacts d'urgence**
                
                - üè´ <strong>√âcole</strong> : {school_name}
                - üìû <strong>Direction</strong> : [Ici on mets le numero de Bernard T.]
                - üöë <strong>SAMU</strong> : 15 (urgences m√©dicales)
                - üè• <strong>Centre de sant√© local</strong> : [Ici on mets le numero de M. Laminou S L.]
                
                <div style="background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>üí° Conseil :</strong> Gardez ces num√©ros dans votre t√©l√©phone !
                </div>
                """, unsafe_allow_html=True)
        
        else:
            # Si pas de donn√©es disponibles
            st.warning("‚ö†Ô∏è Donn√©es de qualit√© de l'air non disponibles pour le moment.")
            st.markdown("""
            **En attendant, voici quelques conseils g√©n√©raux :**
            - üíß Encouragez votre enfant √† bien s'hydrater √† l'√©cole
            - üßº Rappellez-lui de se laver les mains r√©guli√®rement
            - üëÇ Demandez-lui comment il se sent apr√®s l'√©cole
            - üìû Contactez l'√©cole si vous avez des pr√©occupations
            """)
        
        st.markdown("</div>", unsafe_allow_html=True)




#================================================ SECTION D'ENVOI DE SMS AUTO ==============================================

class SMSAlertSystem:
    """
    Syst√®me d'alertes SMS pour les parents
    G√®re l'envoi automatique de notifications selon la qualit√© de l'air √† l'√©cole
    """
    
    def __init__(self, contacts_file="parents_contacts.txt", config_file="sms_config.json"):
        self.contacts_file = contacts_file
        self.config_file = config_file
        self.sent_alerts_file = "sent_alerts.json"
        
        # Configuration par d√©faut
        self.default_config = {
            "sms_provider": "twilio",  # ou "orange_sms_senegal", "free_sms"
            "twilio_account_sid": "ACabfcb37ffd779fca3dfdb47a028352a7",
            "twilio_auth_token": "8699c97724e7c3458fb5a0f79dffbc5e",
            "twilio_phone_number": "+17754297649",
            "orange_api_key": "",
            "max_sms_per_day": 5,
            "quiet_hours_start": "21:00",
            "quiet_hours_end": "07:00",
            "pm25_alert_threshold": 35,
            "pm25_danger_threshold": 55,
            "co2_alert_threshold": 1000,
            "enabled": True
        }
        
        self.load_config()
        self.load_sent_alerts()
    
    def load_config(self):
        """Charge la configuration SMS"""
        try:
            if os.path.exists(self.config_file):
                with open(self.config_file, 'r', encoding='utf-8') as f:
                    self.config = json.load(f)
            else:
                self.config = self.default_config.copy()
                self.save_config()
        except Exception as e:
            st.error(f"Erreur chargement config SMS : {e}")
            self.config = self.default_config.copy()
    
    def save_config(self):
        """Sauvegarde la configuration"""
        try:
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            st.error(f"Erreur sauvegarde config : {e}")
    
    def load_sent_alerts(self):
        """Charge l'historique des alertes envoy√©es"""
        try:
            if os.path.exists(self.sent_alerts_file):
                with open(self.sent_alerts_file, 'r', encoding='utf-8') as f:
                    self.sent_alerts = json.load(f)
            else:
                self.sent_alerts = {}
        except:
            self.sent_alerts = {}
    
    
    
    def save_sent_alerts(self):
        """Sauvegarde l'historique des alertes"""
        try:
            with open(self.sent_alerts_file, 'w', encoding='utf-8') as f:
                json.dump(self.sent_alerts, f, indent=2, ensure_ascii=False)
        except Exception as e:
            st.error(f"Erreur sauvegarde alertes : {e}")
    
    
    
    def load_parent_contacts(self):
        """
        Charge la liste des contacts parents depuis le fichier txt
        Format attendu : nom,telephone,enfant,classe
        """
        contacts = []
        try:
            if os.path.exists(self.contacts_file):
                with open(self.contacts_file, 'r', encoding='utf-8') as f:
                    for line_num, line in enumerate(f, 1):
                        line = line.strip()
                        if line and not line.startswith('#'):  # Ignorer lignes vides et commentaires
                            parts = line.split(',')
                            if len(parts) >= 4:
                                contacts.append({
                                    'nom': parts[0].strip(),
                                    'telephone': parts[1].strip(),
                                    'enfant': parts[2].strip(),
                                    'classe': parts[3].strip(),
                                    'line_num': line_num
                                })
                            else:
                                st.warning(f"Ligne {line_num} mal format√©e : {line}")
            else:
                st.warning(f"Fichier {self.contacts_file} non trouv√©")
        except Exception as e:
            st.error(f"Erreur lecture contacts : {e}")
        
        return contacts
    
    
    
    
    def is_quiet_hours(self):
        """V√©rifie si on est dans les heures de silence"""
        now = datetime.now().time()
        start_time = datetime.strptime(self.config['quiet_hours_start'], '%H:%M').time()
        end_time = datetime.strptime(self.config['quiet_hours_end'], '%H:%M').time()
        
        if start_time <= end_time:
            return start_time <= now <= end_time
        else:  # Cas o√π les heures passent minuit
            return now >= start_time or now <= end_time
    
    
    
    
    def can_send_alert(self, alert_type, phone_number):
        """V√©rifie si on peut envoyer une alerte (anti-spam)"""
        today = datetime.now().strftime('%Y-%m-%d')
        key = f"{phone_number}_{alert_type}_{today}"
        
        # V√©rifier si d√©j√† envoy√© aujourd'hui
        if key in self.sent_alerts:
            return False
        
        # V√©rifier le nombre total d'SMS envoy√©s aujourd'hui
        daily_count = sum(1 for k in self.sent_alerts.keys() 
                         if k.startswith(f"{phone_number}_") and k.endswith(f"_{today}"))
        
        return daily_count < self.config['max_sms_per_day']
    
    
    
    
    def generate_alert_message(self, alert_type, air_data, school_name, child_name):
        """G√©n√®re le message d'alerte personnalis√©"""
        pm25 = air_data.get('pm25', 0)
        co2 = air_data.get('co2', 400)
        status = air_data.get('status', 'Inconnue')
        
        messages = {
            'pollution_high': f"""üö® ALERTE POLLUTION - {school_name}
                Bonjour, l'air √† l'√©cole de {child_name} est tr√®s pollu√© (PM2.5: {pm25:.1f}).
                Surveillez: toux, fatigue, irritations.
                Hydratation++ recommand√©e.
                Dashboard: [lien]""",
                            
            'pollution_moderate': f"""‚ö†Ô∏è Air d√©grad√© - {school_name}
                L'air √† l'√©cole de {child_name} s'est d√©grad√© (PM2.5: {pm25:.1f}).
                Surveillez son √©tat en rentrant.
                Plus d'infos: [lien dashboard]""",
                            
            'co2_high': f"""üí® Ventilation insuffisante - {school_name}
                Le CO2 est √©lev√© dans la classe de {child_name} ({co2:.0f} ppm).
                Peut causer fatigue/difficult√©s de concentration.
                L'√©cole a √©t√© inform√©e.""",
                            
            'back_to_normal': f"""‚úÖ Air redevenu sain - {school_name}
                Bonne nouvelle ! L'air √† l'√©cole de {child_name} est redevenu bon.
                Activit√©s normales possibles.
                Merci de votre vigilance.""",
                            
            'daily_report': f"""üìä Rapport quotidien - {school_name}
                Air aujourd'hui: {status}
                PM2.5 moyen: {pm25:.1f}
                {child_name} a respir√© dans de {'bonnes' if pm25 <= 15 else 'moyennes' if pm25 <= 35 else 'mauvaises'} conditions.
                D√©tails: [lien]""",
                            
            'weekly_summary': f"""üìà R√©sum√© de la semaine - {school_name}
                L'air √† l'√©cole de {child_name} cette semaine:
                - Qualit√© moyenne: {status}
                - Jours d'alerte: [√† calculer]
                Consultez le dashboard pour plus de d√©tails."""
        }
        
        return messages.get(alert_type, f"Alerte qualit√© air - {school_name}: {status}")
    
    
    
    
    def send_sms_twilio(self, phone_number, message):
        """Envoie SMS via Twilio"""
        try:
            account_sid = self.default_config['twilio_account_sid']
            auth_token = self.default_config['twilio_auth_token']
            from_number = self.default_config['twilio_phone_number']

            client = Client(account_sid, auth_token)

            if not phone_number.startswith('+'):
                phone_number = f"+221{phone_number.lstrip('0')}"

            sms = client.messages.create(
                body=message,
                from_=from_number,
                to=phone_number
            )

            print(sms.body)
            return True, f"SMS envoy√© (SID: {sms.sid})"
        except Exception as e:
            return False, f"Erreur Twilio: {str(e)}"

    
    
    
    
    
    def send_sms(self, phone_number, message):
        """Envoie SMS selon le provider configur√©"""
        if not self.config['enabled']:
            return False, "Syst√®me SMS d√©sactiv√©"
        
        if self.is_quiet_hours():
            return False, "Heures de silence"
        
        provider = self.config['sms_provider']
        
        if provider == 'twilio':
            return self.send_sms_twilio(phone_number, message)
        elif provider == 'orange_sms_senegal':
            return self.send_sms_orange_senegal(phone_number, message)
        elif provider == 'free_sms':
            return self.send_sms_free(phone_number, message)
        else:
            return False, f"Provider SMS inconnu: {provider}"
        
        
        
    
    def send_alert_to_parents(self, alert_type, air_data, school_name, selected_classes=None):
        """
        Envoie une alerte √† tous les parents concern√©s
        """
        contacts = self.load_parent_contacts()
        results = []
        sent_count = 0
        
        for contact in contacts:
            # Filtrer par classe si sp√©cifi√©
            if selected_classes and contact['classe'] not in selected_classes:
                continue
            
            phone = contact['telephone']
            child_name = contact['enfant']
            parent_name = contact['nom']
            
            # V√©rifier si on peut envoyer
            if not self.can_send_alert(alert_type, phone):
                results.append({
                    'parent': parent_name,
                    'phone': phone,
                    'status': 'Ignor√©',
                    'reason': 'Limite quotidienne atteinte'
                })
                continue
            
            # G√©n√©rer le message personnalis√©
            message = self.generate_alert_message(alert_type, air_data, school_name, child_name)
            
            # Envoyer le SMS
            success, reason = self.send_sms(phone, message)
            
            if success:
                # Marquer comme envoy√©
                today = datetime.now().strftime('%Y-%m-%d')
                key = f"{phone}_{alert_type}_{today}"
                self.sent_alerts[key] = {
                    'timestamp': datetime.now().isoformat(),
                    'parent': parent_name,
                    'child': child_name,
                    'message': message[:100] + '...'  # Extrait du message
                }
                sent_count += 1
            
            results.append({
                'parent': parent_name,
                'phone': phone,
                'child': child_name,
                'status': 'Envoy√©' if success else '√âchec',
                'reason': reason
            })
        
        # Sauvegarder l'historique
        self.save_sent_alerts()
        
        return results, sent_count
    
    
    
    
    
    def check_and_send_automatic_alerts(self, location_id, token, school_name):
        """
        V√©rifie les conditions et envoie automatiquement des alertes si n√©cessaire
        """
                
        # R√©cup√©rer les donn√©es actuelles
        current_data = fetch_current_data(location_id, token)
        if current_data.empty:
            return [], 0
        
        air_status = calculate_air_quality_status(current_data)
        if not air_status:
            return [], 0
        
        pm25 = air_status['pm25']
        co2 = air_status['co2']
        
        alerts_sent = []
        total_sent = 0
        
        # Alerte pollution √©lev√©e
        if pm25 > self.config['pm25_danger_threshold']:
            results, count = self.send_alert_to_parents('pollution_high', air_status, school_name)
            alerts_sent.extend(results)
            total_sent += count
        
        # Alerte pollution mod√©r√©e
        elif pm25 > self.config['pm25_alert_threshold']:
            results, count = self.send_alert_to_parents('pollution_moderate', air_status, school_name)
            alerts_sent.extend(results)
            total_sent += count
        
        # Alerte CO2 √©lev√©
        if co2 > self.config['co2_alert_threshold']:
            results, count = self.send_alert_to_parents('co2_high', air_status, school_name)
            alerts_sent.extend(results)
            total_sent += count
        
        return alerts_sent, total_sent




def render_bloc_messages_alertes(location_id: str, token: str, school_name="√âcole Primaire Mamadou Dia"):
    """
    Interface Streamlit pour le syst√®me d'alertes SMS
    """
    
    st.markdown("### üì¨ **Messages & Alertes SMS**")
    
    # Initialiser le syst√®me SMS
    sms_system = SMSAlertSystem()
    
    with st.container():
        st.markdown("""
        <div style="background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%); 
                    padding: 25px; border-radius: 15px; margin-bottom: 20px; 
                    border: 1px solid #ffb3b3;">
        """, unsafe_allow_html=True)
        
        # === ONGLETS ===
        tab1, tab2, tab3, tab4 = st.tabs(["üì± Envoi Manuel", "‚öôÔ∏è Configuration", "üìä Historique", "üîÑ Auto-Check"])
        
        with tab1:
            st.markdown("#### üì± **Envoi manuel d'alertes**")
            
            # S√©lection du type d'alerte
            col1, col2 = st.columns([1, 1])
            with col1:
                alert_type = st.selectbox(
                    "Type d'alerte",
                    options=['pollution_high', 'pollution_moderate', 'co2_high', 'back_to_normal', 'daily_report'],
                    format_func=lambda x: {
                        'pollution_high': 'üö® Pollution √©lev√©e',
                        'pollution_moderate': '‚ö†Ô∏è Pollution mod√©r√©e',
                        'co2_high': 'üí® CO2 √©lev√©',
                        'back_to_normal': '‚úÖ Retour normal',
                        'daily_report': 'üìä Rapport quotidien'
                    }[x]
                )
            
            with col2:
                # Charger les contacts pour s√©lection
                contacts = sms_system.load_parent_contacts()
                if contacts:
                    classes = list(set(c['classe'] for c in contacts))
                    selected_classes = st.multiselect(
                        "Classes √† alerter",
                        options=classes,
                        default=classes
                    )
                else:
                    st.warning("Aucun contact trouv√©")
                    selected_classes = []
            
            # Aper√ßu du message
            if contacts:
                current_data = fetch_current_data(location_id, token)
                air_status = calculate_air_quality_status(current_data) if not current_data.empty else None
                
                if air_status:
                    sample_message = sms_system.generate_alert_message(
                        alert_type, air_status, school_name, "Exemple Enfant"
                    )
                    st.markdown("**Aper√ßu du message :**")
                    st.info(sample_message)
                    
                    # Bouton d'envoi
                    if st.button("üì§ Envoyer les alertes", type="primary"):
                        with st.spinner("Envoi en cours..."):
                            results, sent_count = sms_system.send_alert_to_parents(
                                alert_type, air_status, school_name, selected_classes
                            )
                            
                            st.success(f"‚úÖ {sent_count} SMS envoy√©s avec succ√®s !")
                            
                            # Afficher les r√©sultats
                            if results:
                                df_results = pd.DataFrame(results)
                                st.dataframe(df_results, use_container_width=True)
                else:
                    st.warning("Donn√©es de qualit√© de l'air non disponibles")
        
        with tab2:
            st.markdown("#### ‚öôÔ∏è **Configuration du syst√®me SMS**")
            
            # Configuration g√©n√©rale
            col1, col2 = st.columns([1, 1])
            
            with col1:
                
                st.markdown("##### üì° **Provider SMS**")

                options = ['twilio', 'orange_sms_senegal', 'free_sms']
                default = sms_system.config.get('sms_provider', 'twilio')
                default_index = options.index(default) if default in options else 0

                sms_system.config['sms_provider'] = st.selectbox(
                    "Service SMS",
                    options=options,
                    index=default_index,
                    help="Twilio: Fiable mais payant | Orange: Local S√©n√©gal | Free: Tests uniquement"
                )

                
                if sms_system.config['sms_provider'] == 'twilio':
                    sms_system.config['twilio_account_sid'] = st.text_input(
                        "Twilio Account SID", 
                        value=sms_system.config.get('twilio_account_sid', ''),
                        type="password"
                    )
                    sms_system.config['twilio_auth_token'] = st.text_input(
                        "Twilio Auth Token", 
                        value=sms_system.config.get('twilio_auth_token', ''),
                        type="password"
                    )
                    sms_system.config['twilio_phone_number'] = st.text_input(
                        "Num√©ro Twilio", 
                        value=sms_system.config.get('twilio_phone_number', ''),
                        placeholder="+221xxxxxxxxx"
                    )
                
                elif sms_system.config['sms_provider'] == 'orange_sms_senegal':
                    sms_system.config['orange_api_key'] = st.text_input(
                        "Cl√© API Orange", 
                        value=sms_system.config.get('orange_api_key', ''),
                        type="password"
                    )
            
            with col2:
                st.markdown("##### ‚è∞ **Param√®tres d'envoi**")
                sms_system.config['max_sms_per_day'] = st.number_input(
                    "Max SMS par parent/jour", 
                    min_value=1, max_value=20, 
                    value=sms_system.config['max_sms_per_day']
                )
                
                sms_system.config['quiet_hours_start'] = st.time_input(
                    "D√©but heures de silence", 
                    value=datetime.strptime(sms_system.config['quiet_hours_start'], '%H:%M').time()
                ).strftime('%H:%M')
                
                sms_system.config['quiet_hours_end'] = st.time_input(
                    "Fin heures de silence", 
                    value=datetime.strptime(sms_system.config['quiet_hours_end'], '%H:%M').time()
                ).strftime('%H:%M')
                
                st.markdown("##### üéØ **Seuils d'alerte**")
                sms_system.config['pm25_alert_threshold'] = st.number_input(
                    "PM2.5 Alerte (¬µg/m¬≥)", 
                    min_value=10, max_value=100, 
                    value=sms_system.config['pm25_alert_threshold']
                )
                
                sms_system.config['pm25_danger_threshold'] = st.number_input(
                    "PM2.5 Danger (¬µg/m¬≥)", 
                    min_value=30, max_value=200, 
                    value=sms_system.config['pm25_danger_threshold']
                )
                
                sms_system.config['enabled'] = st.checkbox(
                    "Syst√®me SMS activ√©", 
                    value=sms_system.config['enabled']
                )
            
            # Sauvegarder la configuration
            if st.button("üíæ Sauvegarder la configuration"):
                sms_system.save_config()
                st.success("Configuration sauvegard√©e !")
            
            # Gestion des contacts
            st.markdown("---")
            st.markdown("##### üë• **Gestion des contacts parents**")
            
            # Upload du fichier contacts
            uploaded_file = st.file_uploader(
                "Importer fichier contacts (CSV/TXT)", 
                type=['txt', 'csv'],
                help="Format: nom,telephone,enfant,classe"
            )
            
            if uploaded_file:
                content = uploaded_file.read().decode('utf-8')
                with open(sms_system.contacts_file, 'w', encoding='utf-8') as f:
                    f.write(content)
                st.success("Fichier contacts import√© !")
            
            # Afficher les contacts actuels
            contacts = sms_system.load_parent_contacts()
            if contacts:
                st.markdown(f"**{len(contacts)} contacts trouv√©s :**")
                df_contacts = pd.DataFrame(contacts)[['nom', 'telephone', 'enfant', 'classe']]
                st.dataframe(df_contacts, use_container_width=True)
            
        with tab3:
            st.markdown("#### üìä **Historique des envois**")
            
            # Afficher l'historique
            if sms_system.sent_alerts:
                history_data = []
                for key, data in sms_system.sent_alerts.items():
                    phone, alert_type, date = key.split('_', 2)
                    history_data.append({
                        'Date': date,
                        'Type': alert_type,
                        'Parent': data.get('parent', 'Inconnu'),
                        'Enfant': data.get('child', 'Inconnu'),
                        'T√©l√©phone': phone,
                        'Heure': data.get('timestamp', '').split('T')[1][:5] if 'T' in data.get('timestamp', '') else '',
                        'Message': data.get('message', '')
                    })
                
                df_history = pd.DataFrame(history_data)
                
                # Filtres
                col1, col2 = st.columns([1, 1])
                with col1:
                    date_filter = st.date_input("Filtrer par date", value=datetime.now().date())
                with col2:
                    type_filter = st.selectbox("Filtrer par type", options=['Tous'] + list(set(df_history['Type'])))
                
                # Appliquer les filtres
                filtered_df = df_history.copy()
                if date_filter:
                    filtered_df = filtered_df[filtered_df['Date'] == date_filter.strftime('%Y-%m-%d')]
                if type_filter != 'Tous':
                    filtered_df = filtered_df[filtered_df['Type'] == type_filter]
                
                st.dataframe(filtered_df, use_container_width=True)
                
                # Statistiques
                st.markdown("##### üìà **Statistiques**")
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("Total SMS envoy√©s", len(history_data))
                with col2:
                    today_count = len([d for d in history_data if d['Date'] == datetime.now().strftime('%Y-%m-%d')])
                    st.metric("SMS aujourd'hui", today_count)
                with col3:
                    unique_parents = len(set(d['Parent'] for d in history_data))
                    st.metric("Parents contact√©s", unique_parents)
            else:
                st.info("Aucun SMS envoy√© pour le moment")
        
        with tab4:
            st.markdown("#### üîÑ **V√©rification automatique**")
            
            # Statut du syst√®me
            col1, col2 = st.columns([1, 1])
            with col1:
                st.markdown("##### üì° **Statut syst√®me**")
                if sms_system.config['enabled']:
                    st.success("‚úÖ Syst√®me activ√©")
                else:
                    st.error("‚ùå Syst√®me d√©sactiv√©")
                
                if sms_system.is_quiet_hours():
                    st.warning("üîá Heures de silence")
                else:
                    st.info("üîä Envois autoris√©s")
            
            with col2:
                st.markdown("##### üéØ **Configuration actuelle**")
                st.text(f"Provider: {sms_system.config['sms_provider']}")
                st.text(f"Seuil PM2.5: {sms_system.config['pm25_alert_threshold']} ¬µg/m¬≥")
                st.text(f"Max SMS/jour: {sms_system.config['max_sms_per_day']}")
            
            # Test de v√©rification manuelle
            if st.button("üîç V√©rifier maintenant", type="primary"):
                with st.spinner("V√©rification en cours..."):
                    results, sent_count = sms_system.check_and_send_automatic_alerts(
                        location_id, token, school_name
                    )
                    
                    if sent_count > 0:
                        st.success(f"‚úÖ {sent_count} alertes automatiques envoy√©es !")
                        df_results = pd.DataFrame(results)
                        st.dataframe(df_results)
                    else:
                        st.info("‚ÑπÔ∏è Aucune alerte n√©cessaire pour le moment")
        
        st.markdown("</div>", unsafe_allow_html=True)




# === FONCTION POUR AUTOMATISER LES ALERTES ===
def setup_automatic_alerts(location_id, token, school_name, check_interval_minutes=30):
    """
    Configure un syst√®me d'alertes automatiques
    √Ä int√©grer dans un scheduler (cron, celery, etc.)
    """

    def check_alerts_loop():
        sms_system = SMSAlertSystem()
        
        while True:
            try:
                # V√©rifier seulement pendant les heures ouvrables
                current_hour = datetime.now().hour
                if 7 <= current_hour <= 18:  # Entre 7h et 18h
                    results, sent_count = sms_system.check_and_send_automatic_alerts(
                        location_id, token, school_name
                    )
                    
                    if sent_count > 0:
                        print(f"[{datetime.now()}] {sent_count} alertes automatiques envoy√©es")
                    
                # Attendre l'intervalle suivant
                time.sleep(check_interval_minutes * 60)
                
            except Exception as e:
                print(f"[{datetime.now()}] Erreur check automatique: {e}")
                time.sleep(300)  # Attendre 5 min en cas d'erreur
    
    # Lancer en arri√®re-plan
    alert_thread = threading.Thread(target=check_alerts_loop, daemon=True)
    alert_thread.start()
    
    return alert_thread

# === INT√âGRATION AVEC STREAMLIT SCHEDULER ===
def setup_streamlit_scheduler():
    """
    Configure les t√¢ches automatiques pour Streamlit
    """
    import streamlit as st
    
    # V√©rifier si le scheduler est d√©j√† en cours
    if 'alert_scheduler_running' not in st.session_state:
        st.session_state.alert_scheduler_running = False
    
    if not st.session_state.alert_scheduler_running:
        # D√©marrer le scheduler
        location_id = st.session_state.get('location_id', 'default')
        token = st.session_state.get('api_token', 'default')
        school_name = st.session_state.get('school_name', '√âcole par d√©faut')
        
        setup_automatic_alerts(location_id, token, school_name)
        st.session_state.alert_scheduler_running = True

# === WEBHOOK POUR INT√âGRATIONS EXTERNES ===
def create_webhook_handler():
    """
    Cr√©er un endpoint webhook pour recevoir des alertes externes
    Exemple d'usage avec Flask ou FastAPI
    """
    webhook_code = '''
    from flask import Flask, request, jsonify
    from datetime import datetime

    app = Flask(__name__)
    sms_system = SMSAlertSystem()

    @app.route('/webhook/air-quality-alert', methods=['POST'])
    def handle_air_quality_webhook():
        """
        Endpoint pour recevoir des alertes de qualit√© d'air
        
        Payload attendu:
        {
            "location_id": "school_001",
            "school_name": "√âcole Primaire XYZ",
            "alert_type": "pollution_high",
            "air_data": {
                "pm25": 45.2,
                "co2": 800,
                "status": "Mauvaise",
                "timestamp": "2024-01-01T12:00:00Z"
            },
            "classes": ["CM1", "CM2"]  # Optionnel
        }
        """
        try:
            data = request.json
            
            location_id = data.get('location_id')
            school_name = data.get('school_name', '√âcole inconnue')
            alert_type = data.get('alert_type')
            air_data = data.get('air_data', {})
            selected_classes = data.get('classes')
            
            # Validation
            if not all([location_id, alert_type, air_data]):
                return jsonify({"error": "Donn√©es manquantes"}), 400
            
            # Envoyer les alertes
            results, sent_count = sms_system.send_alert_to_parents(
                alert_type, air_data, school_name, selected_classes
            )
            
            return jsonify({
                "success": True,
                "sent_count": sent_count,
                "timestamp": datetime.now().isoformat(),
                "results": results
            }), 200
            
        except Exception as e:
            return jsonify({"error": str(e)}), 500

    @app.route('/webhook/test-sms', methods=['POST'])
    def test_sms_endpoint():
        """Test endpoint pour v√©rifier la configuration SMS"""
        try:
            data = request.json
            phone = data.get('phone')
            message = data.get('message', 'Test SMS depuis RESPiRE Dashboard')
            
            if not phone:
                return jsonify({"error": "Num√©ro de t√©l√©phone requis"}), 400
            
            success, reason = sms_system.send_sms(phone, message)
            
            return jsonify({
                "success": success,
                "reason": reason,
                "timestamp": datetime.now().isoformat()
            }), 200
            
        except Exception as e:
            return jsonify({"error": str(e)}), 500

    if __name__ == '__main__':
        app.run(host='0.0.0.0', port=5000, debug=True)
        '''
        
    return webhook_code

# === DOCUMENTATION D'UTILISATION ===
def render_sms_documentation():
    """
    Affiche la documentation du syst√®me SMS
    """
    st.markdown("""
    ## üìö **Documentation - Syst√®me d'Alertes SMS**
    
    ### üöÄ **Installation et Configuration**
    
    #### 1. **Pr√©requis**
    ```bash
    pip install twilio requests streamlit pandas
    ```
    
    #### 2. **Fichier de contacts (parents_contacts.txt)**
    ```
    # Format: nom,telephone,enfant,classe
    Aminata Diallo,771234567,Fatou Diallo,CP
    Moussa Ndiaye,775678901,Omar Ndiaye,CP
    ```
    
    #### 3. **Configuration Twilio**
    1. Cr√©er un compte sur [twilio.com](https://twilio.com)
    2. Obtenir Account SID et Auth Token
    3. Acheter un num√©ro de t√©l√©phone Twilio
    4. Configurer dans l'interface
    
    ### üì± **Types d'Alertes Disponibles**
    
    | Type | D√©clencheur | Message type |
    |------|-------------|--------------|
    | `pollution_high` | PM2.5 > 55 ¬µg/m¬≥ | üö® Alerte rouge |
    | `pollution_moderate` | PM2.5 > 35 ¬µg/m¬≥ | ‚ö†Ô∏è Alerte orange |
    | `co2_high` | CO2 > 1000 ppm | üí® Ventilation |
    | `back_to_normal` | Retour normal | ‚úÖ Rassurance |
    | `daily_report` | Rapport quotidien | üìä R√©sum√© |
    
    ### ‚öôÔ∏è **Configuration Avanc√©e**
    
    #### **Seuils personnalisables**
    - PM2.5 alerte: 35 ¬µg/m¬≥ (modifiable)
    - PM2.5 danger: 55 ¬µg/m¬≥ (modifiable)
    - CO2 alerte: 1000 ppm (modifiable)
    
    #### **Limitations anti-spam**
    - Max 5 SMS par parent/jour (configurable)
    - Heures de silence: 21h-7h (configurable)
    - Pas de doublon sur m√™me alerte/jour
    
    ### üîß **Int√©grations**
    
    #### **Webhook automatique**
    ```python
    import requests
    
    # Envoyer alerte via webhook
    data = {
        "location_id": "school_001",
        "school_name": "√âcole XYZ",
        "alert_type": "pollution_high",
        "air_data": {"pm25": 45, "status": "Mauvaise"}
    }
    
    response = requests.post("http://localhost:5000/webhook/air-quality-alert", json=data)
    ```
    
    #### **Scheduler automatique**
    ```python
    # V√©rification toutes les 30 minutes
    setup_automatic_alerts("location_id", "token", "√âcole XYZ", 30)
    ```
    
    ### üí° **Bonnes Pratiques**
    
    1. **Tester d'abord** avec le provider `free_sms`
    2. **V√©rifier les num√©ros** au format international (+221...)
    3. **Surveiller les co√ªts** avec Twilio
    4. **Backup des contacts** r√©gulier
    5. **Messages courts** (max 160 caract√®res recommand√©)
    
    ### üÜò **D√©pannage**
    
    | Probl√®me | Solution |
    |----------|----------|
    | SMS non re√ßus | V√©rifier num√©ro format +221... |
    | Erreur Twilio | V√©rifier cr√©dits et tokens |
    | Heures silence | Changer config quiet_hours |
    | Limite quotidienne | Augmenter max_sms_per_day |
    
    ### üìû **Support**
    
    - **Twilio Support**: [support.twilio.com](https://support.twilio.com)
    - **Orange S√©n√©gal**: 8080 (num√©ro gratuit)
    - **Documentation**: [docs.twilio.com](https://docs.twilio.com)
    """)


# === FONCTION D'UTILISATION PRINCIPALE ===
def show_sms_sytem():
    """Fonction principale pour tester le syst√®me SMS"""
    
    st.title("üì± **RESPiRE - Syst√®me d'Alertes SMS**")
    
    # Rendu du bloc principal
    school_name = "ESMT"
    render_bloc_messages_alertes(location_id, token, school_name)
    
    # Documentation
    with st.expander("üìö Voir la documentation compl√®te"):
        render_sms_documentation()





















#=========================== SECTION TOUT EN BAS RESERVEE AU FOOTER =================================

# show_footer()